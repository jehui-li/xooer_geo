# GEO Agent 部署文档

## 一、环境准备

### 后端环境
- Python 3.10+
- MongoDB（本地或远程）
- 至少一个 LLM API 密钥（OpenAI/Google Vertex AI/Perplexity/X API）

### 前端环境
- Node.js 18+
- npm/yarn/pnpm

## 二、后端部署

### 1. 安装依赖
```bash
cd /Users/zhihuili/Desktop/codes/geo_agent
python3 -m venv venv
source venv/bin/activate  # macOS/Linux
# 或 venv\Scripts\activate  # Windows
pip install -r requirements.txt
```

### 2. 配置环境变量
创建 `.env` 文件（项目根目录）：
```bash
# 必需
API_KEY=your-secret-api-key
MONGODB_URI=mongodb://localhost:27017
MONGODB_DATABASE=geo_agent

# 至少配置一个 LLM API
OPENAI_API_KEY=your-key
# 或
GOOGLE_PROJECT_ID=your-project-id
# 或
PERPLEXITY_API_KEY=your-key
# 或
X_API_KEY=your-key
```

### 3. 启动 MongoDB
```bash
# 本地 MongoDB
brew services start mongodb-community  # macOS
# 或
docker run -d -p 27017:27017 --name mongodb mongo:latest
```

### 4. 启动后端服务
```bash
# 开发模式
python run_api.py

# 生产模式
uvicorn src.api.main:app --host 0.0.0.0 --port 8000 --workers 4
```

## 三、前端部署

### 1. 安装依赖
```bash
cd frontend
npm install
```

### 2. 配置环境变量
创建 `frontend/.env.local`：
```bash
NEXT_PUBLIC_API_URL=http://localhost:8000
NEXT_PUBLIC_API_KEY=your-secret-api-key  # 与后端 API_KEY 一致
```

### 3. 启动服务
```bash
# 开发模式
npm run dev

# 生产模式
npm run build
npm start
```

## 四、验证部署

### 后端验证
- 健康检查：`curl http://localhost:8000/health`
- API 文档：`http://localhost:8000/docs`
- 根路径：`curl http://localhost:8000/`

### 前端验证
- 访问：`http://localhost:3000`
- 检查 API 连接是否正常

## 五、生产环境部署

### 方案 1：使用 systemd (Linux)

**后端服务文件** `/etc/systemd/system/geo-agent-api.service`:
```ini
[Unit]
Description=GEO Agent API
After=network.target mongodb.service

[Service]
Type=simple
User=your-user
WorkingDirectory=/path/to/geo_agent
Environment="PATH=/path/to/venv/bin"
ExecStart=/path/to/venv/bin/uvicorn src.api.main:app --host 0.0.0.0 --port 8000 --workers 4
Restart=always

[Install]
WantedBy=multi-user.target
```

**启动服务**:
```bash
sudo systemctl daemon-reload
sudo systemctl enable geo-agent-api
sudo systemctl start geo-agent-api
```

### 方案 2：使用 Docker Compose

创建 `docker-compose.yml`:
```yaml
version: '3.8'
services:
  mongodb:
    image: mongo:latest
    ports:
      - "27017:27017"
    volumes:
      - mongodb_data:/data/db

  backend:
    build:
      context: .
      dockerfile: Dockerfile.backend
    ports:
      - "8000:8000"
    depends_on:
      - mongodb
    environment:
      - MONGODB_URI=mongodb://mongodb:27017

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    ports:
      - "3000:3000"
    depends_on:
      - backend
```

### 方案 3：使用 PM2 (Node.js 进程管理)

```bash
# 安装 PM2
npm install -g pm2

# 启动后端（需要配置 ecosystem.config.js）
pm2 start ecosystem.config.js

# 启动前端
cd frontend
pm2 start npm --name "geo-agent-frontend" -- start
```

## 六、Nginx 反向代理配置

```nginx
# 后端 API
server {
    listen 80;
    server_name api.yourdomain.com;
    
    location / {
        proxy_pass http://localhost:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}

# 前端
server {
    listen 80;
    server_name yourdomain.com;
    
    location / {
        proxy_pass http://localhost:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

## 七、安全配置

1. **API 密钥**：不要提交 `.env` 到 Git
2. **CORS**：生产环境限制允许的源
3. **HTTPS**：使用 SSL 证书
4. **API 认证**：确保使用 API Key
5. **防火墙**：只开放必要端口

## 八、常见问题

1. **MongoDB 连接失败**：检查 MongoDB 是否运行、URI 是否正确
2. **端口被占用**：修改 `run_api.py` 中的端口或释放端口
3. **API 连接失败**：检查 `NEXT_PUBLIC_API_URL`、API Key 是否一致
4. **依赖安装失败**：检查 Python/Node.js 版本

## 九、快速命令

```bash
# 启动所有服务
./deploy.sh

# 停止所有服务
./stop_services.sh

# 查看后端日志
tail -f /tmp/geo_agent_backend.log

# 查看前端日志
tail -f /tmp/geo_agent_frontend.log
```

## 十、部署检查清单

- [ ] Python 3.10+ 已安装
- [ ] Node.js 18+ 已安装
- [ ] MongoDB 已安装并运行
- [ ] `.env` 文件已配置
- [ ] `frontend/.env.local` 已配置
- [ ] 至少一个 LLM API 密钥已配置
- [ ] 后端服务可访问
- [ ] 前端服务可访问
- [ ] API 连接正常
- [ ] 生产环境 HTTPS 已配置（如适用）